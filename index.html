<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh Qu·∫£n l√Ω T√†i li·ªáu</title>
    <style>
        /* CSS Reset & Basic Styling */
        :root {
            --primary-color: #4285F4;
            --danger-color: #DB4437;
            --light-gray: #f5f5f5;
            --dark-gray: #757575;
            --border-radius: 8px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 24px;
            margin: 0;
            color: #333;
        }

        /* Authentication Section */
        #auth-container { text-align: center; padding: 40px 0; }
        .auth-button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #sign-in-btn { background-color: var(--primary-color); color: white; }
        #sign-in-btn:hover { background-color: #3367D6; }
        #sign-out-btn { background-color: var(--danger-color); color: white; }
        #sign-out-btn:hover { background-color: #C5372C; }

        /* App Section */
        #app-container { display: none; } /* Hidden by default */
        #user-info { font-size: 14px; color: var(--dark-gray); }

        /* Form */
        #doc-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #doc-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 16px;
        }
        #doc-form button {
            padding: 10px 20px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
        }

        /* Document List */
        #doc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #doc-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }
        #doc-list li:hover { background-color: #fafafa; }
        #doc-list li.completed span {
            text-decoration: line-through;
            color: var(--dark-gray);
        }
        #doc-list li .actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
            padding: 5px;
        }
        .delete-btn { color: var(--danger-color); }
        .toggle-btn { color: #4CAF50; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Qu·∫£n l√Ω T√†i li·ªáu</h1>
            <div id="user-controls"></div>
        </header>

        <div id="auth-container">
            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</p>
            <button id="sign-in-btn" class="auth-button">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
        </div>

        <main id="app-container">
            <p id="user-info"></p>
            <form id="doc-form">
                <input type="text" id="doc-input" placeholder="Nh·∫≠p t√™n t√†i li·ªáu..." required>
                <button type="submit">Th√™m</button>
            </form>
            <ul id="doc-list">
                </ul>
        </main>
    </div>

    <script type="module">
        // Import functions from the Firebase SDK
        // NOTE: In a real project, you'd use npm/yarn. Here, we use the CDN version.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // === 1. INITIALIZATION ===
        // Your web app's Firebase configuration is provided by the environment
        const firebaseConfig = __firebase_config;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // Variable to hold current user info

        // === 2. DOM ELEMENT REFERENCES ===
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const signInBtn = document.getElementById('sign-in-btn');
        const userControls = document.getElementById('user-controls');
        const userInfoDisplay = document.getElementById('user-info');
        const docForm = document.getElementById('doc-form');
        const docInput = document.getElementById('doc-input');
        const docList = document.getElementById('doc-list');
        
        // === 3. AUTHENTICATION LOGIC ===
        const provider = new GoogleAuthProvider();

        // Sign in function
        signInBtn.onclick = () => signInWithPopup(auth, provider);

        // Listen for authentication state changes
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                // User is signed in
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';

                userInfoDisplay.textContent = `Xin ch√†o, ${user.displayName || user.email}`;
                userControls.innerHTML = `<button id="sign-out-btn" class="auth-button">ƒêƒÉng xu·∫•t</button>`;
                document.getElementById('sign-out-btn').onclick = () => signOut(auth);
                
                // Fetch user's documents
                fetchDocuments();
            } else {
                // User is signed out
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                userControls.innerHTML = '';
                docList.innerHTML = ''; // Clear the list on sign out
            }
        });

        // === 4. FIRESTORE (DATABASE) LOGIC ===
        let unsubscribe = null; // To stop listening for changes when user logs out

        // C: Create a new document
        const addDocument = async (title) => {
            if (!currentUser) return; // Guard clause
            try {
                await addDoc(collection(db, "documents"), {
                    title: title,
                    completed: false,
                    createdAt: serverTimestamp(),
                    uid: currentUser.uid // IMPORTANT: Link document to the user
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        // R: Read documents in real-time
        const fetchDocuments = () => {
            if (!currentUser) return;
            
            // If already listening, stop the old listener first
            if (unsubscribe) unsubscribe();

            // Create a query to get only the documents for the current user
            // This is the key to data security and separation!
            const q = query(
                collection(db, "documents"), 
                where("uid", "==", currentUser.uid),
                orderBy("createdAt", "desc")
            );

            // onSnapshot listens for real-time updates
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const documents = [];
                querySnapshot.forEach((doc) => {
                    documents.push({ id: doc.id, ...doc.data() });
                });
                renderDocuments(documents);
            });
        };
        
        // U: Update a document (toggle completed status)
        const toggleDocumentStatus = async (id, currentStatus) => {
            const docRef = doc(db, "documents", id);
            await updateDoc(docRef, {
                completed: !currentStatus
            });
        };

        // D: Delete a document
        const deleteDocument = async (id) => {
            const docRef = doc(db, "documents", id);
            await deleteDoc(docRef);
        };

        // === 5. UI RENDERING & EVENT LISTENERS ===

        // Render the list of documents to the screen
        const renderDocuments = (documents) => {
            docList.innerHTML = ''; // Clear current list
            if (documents.length === 0) {
                docList.innerHTML = '<li><p>Ch∆∞a c√≥ t√†i li·ªáu n√†o. H√£y th√™m m·ªôt t√†i li·ªáu m·ªõi!</p></li>';
                return;
            }
            documents.forEach(doc => {
                const li = document.createElement('li');
                li.className = doc.completed ? 'completed' : '';
                li.setAttribute('data-id', doc.id);

                const span = document.createElement('span');
                span.textContent = doc.title;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';

                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = doc.completed ? '‚Ü©Ô∏è' : '‚úîÔ∏è';
                toggleBtn.className = 'toggle-btn';
                toggleBtn.title = doc.completed ? 'ƒê√°nh d·∫•u ch∆∞a ho√†n th√†nh' : 'ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'X√≥a t√†i li·ªáu';

                actionsDiv.appendChild(toggleBtn);
                actionsDiv.appendChild(deleteBtn);
                
                li.appendChild(span);
                li.appendChild(actionsDiv);
                
                docList.appendChild(li);
            });
        };

        // Event listener for the form submission
        docForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = docInput.value.trim();
            if (title) {
                addDocument(title);
                docInput.value = '';
            }
        });

        // Event listener for clicks on the document list (for update/delete)
        docList.addEventListener('click', (e) => {
            const target = e.target;
            const li = target.closest('li');
            if (!li) return;
            
            const docId = li.dataset.id;
            const isDeleteBtn = target.classList.contains('delete-btn');
            const isToggleBtn = target.classList.contains('toggle-btn');

            if (isDeleteBtn) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i li·ªáu n√†y?')) {
                    deleteDocument(docId);
                }
            }
            
            if (isToggleBtn) {
                const isCompleted = li.classList.contains('completed');
                toggleDocumentStatus(docId, isCompleted);
            }
        });

    </script>
</body>
</html>
