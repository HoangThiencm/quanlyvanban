<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Văn bản Nội bộ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        #file-viewer-iframe {
            width: 100%;
            height: 70vh;
            border: 1px solid #e5e7eb;
        }
        .dark #file-viewer-iframe {
            border-color: #4a5568;
        }
        .file-item.selected {
            background-color: #eef2ff;
        }
        .dark .file-item.selected {
            background-color: #3730a3;
        }
        .table-row-group {
             cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <!-- Thư viện Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 dark:text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Hệ thống Quản lý Văn bản cá nhân</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div id="auth-status" class="flex items-center space-x-2">
                             <button id="authorize_button" class="flex items-center bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-600">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                                 Đăng nhập Google
                             </button>
                             <button id="signout_button" class="hidden bg-gray-200 text-gray-800 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-300">Đăng xuất</button>
                             <p id="user-name" class="text-sm font-medium"></p>
                         </div>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                            <i data-lucide="sun" class="h-5 w-5 block dark:hidden"></i>
                            <i data-lucide="moon" class="h-5 w-5 hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                 <!-- Controls -->
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 mb-6">
                    <div class="w-full md:w-auto flex-grow flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                        <div class="w-full sm:w-auto flex items-center space-x-2">
                            <select id="school-year-select" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></select>
                            <button id="manage-years-btn" title="Quản lý năm học" class="p-2.5 text-gray-500 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-600 flex-shrink-0">
                                <i data-lucide="settings-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="w-full sm:w-40">
                             <select id="doc-month-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            </select>
                        </div>
                        <div class="w-full sm:w-40">
                            <select id="doc-type-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            </select>
                        </div>
                        <div class="relative w-full flex-grow">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input type="search" id="search-input" class="w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Tìm kiếm văn bản...">
                        </div>
                    </div>
                    <button id="add-document-btn" class="w-full md:w-auto flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800 md:ml-4 flex-shrink-0">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Thêm Văn bản Mới
                    </button>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto relative">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="py-3 px-6 rounded-l-lg">STT</th>
                                <th scope="col" class="py-3 px-6">Tên Văn bản / Trích yếu</th>
                                <th scope="col" class="py-3 px-6">Số/Ký hiệu</th>
                                <th scope="col" class="py-3 px-6">Ngày Ban hành</th>
                                <th scope="col" class="py-3 px-6">Tệp đính kèm</th>
                                <th scope="col" class="py-3 px-6">Trạng thái</th>
                                <th scope="col" class="py-3 px-6 rounded-r-lg">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="document-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Thêm/Sửa Văn bản -->
    <div id="document-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">Thêm Văn bản Mới</h3>
                <button id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <form id="document-form" class="space-y-4">
                    <input type="hidden" id="doc-firestore-id">
                    <div>
                        <label for="doc-name" class="block mb-2 text-sm font-medium">Tên văn bản / Trích yếu</label>
                        <input type="text" id="doc-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="doc-id" class="block mb-2 text-sm font-medium">Số/Ký hiệu</label>
                            <input type="text" id="doc-id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="doc-date" class="block mb-2 text-sm font-medium">Ngày ban hành</label>
                            <input type="date" id="doc-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="doc-type" class="block mb-2 text-sm font-medium">Loại văn bản</label>
                            <select id="doc-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                                <option>Kế hoạch</option><option>Báo cáo</option><option>Quyết định</option><option>Thông báo</option><option>Công văn</option><option>Thông tư</option><option>Hướng dẫn</option><option>Quy định</option><option>Nghị quyết</option><option>Nghị định</option> 
                            </select>
                        </div>
                        <div>
                            <label for="doc-status" class="block mb-2 text-sm font-medium">Trạng thái</label>
                            <select id="doc-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                                <option>Chờ xử lý</option><option>Đã xử lý</option><option>Lưu trữ</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="file_input" class="block mb-2 text-sm font-medium">Tải file lên (có thể chọn nhiều file)</label>
                        <input class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600" id="file_input" type="file" multiple>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Khi chỉnh sửa, để trống nếu không muốn thay đổi file.</p>
                        <div id="upload-progress-container" class="hidden mt-2">
                             <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                             </div>
                             <p id="upload-progress-text" class="text-sm text-center mt-1"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button id="save-btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Lưu lại</button>
                <button id="cancel-modal-btn" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5">Hủy bỏ</button>
            </div>
        </div>
    </div>

    <!-- Modal Quản lý Năm học -->
    <div id="school-year-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
             <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold">Quản lý Năm học</h3>
                <button id="close-year-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 rounded-lg text-sm p-1.5"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="new-year-input" class="block mb-2 text-sm font-medium">Thêm năm học mới</label>
                    <div class="flex space-x-2">
                        <input type="text" id="new-year-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="VD: Năm học 2026-2027">
                        <button id="add-year-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Thêm</button>
                    </div>
                </div>
                <div class="max-h-60 overflow-y-auto"><ul id="year-list" class="space-y-2"></ul></div>
            </div>
        </div>
    </div>
    
    <!-- MODAL XEM FILE -->
    <div id="file-viewer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl h-[90vh] mx-4 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h3 id="file-viewer-title" class="text-lg font-semibold text-gray-900 dark:text-white">Các tệp đính kèm</h3>
                <button id="close-viewer-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex flex-grow overflow-hidden">
                <div class="w-1/4 p-4 border-r dark:border-gray-700 overflow-y-auto">
                    <h4 class="text-sm font-semibold mb-3">Danh sách tệp</h4>
                    <ul id="file-list" class="space-y-2"></ul>
                </div>
                <div class="w-3/4 p-4 flex flex-col">
                    <div id="viewer-placeholder" class="flex-grow flex items-center justify-center text-gray-500">
                        <p>Chọn một tệp từ danh sách để xem trước.</p>
                    </div>
                    <iframe id="file-viewer-iframe" class="hidden" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </div>


    <script>
    // --- KHỞI TẠO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA5sGFFmEh-itduCmJEbi53CsrHxWaxeQc",
      authDomain: "quanlyvanban-40a9d.firebaseapp.com",
      projectId: "quanlyvanban-40a9d",
      storageBucket: "quanlyvanban-40a9d.appspot.com",
      messagingSenderId: "856857772073",
      appId: "1:856857772073:web:d09c4b1deead0702f61c38"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUser = null;
    let unsubscribeDocuments = null; 

    document.addEventListener('DOMContentLoaded', () => {
        // --- ADD THIS PART FOR REDIRECT HANDLING ---
        auth.getRedirectResult().catch(error => {
            console.error("Lỗi đăng nhập Google sau khi redirect:", error);
            // Avoid showing generic internal errors to the user
            if (error.code !== 'auth/internal-error') { 
                alert(`Đăng nhập thất bại: ${error.message}`);
            }
        });

        // --- UI REFERENCES ---
        const ui = {
            authBtn: document.getElementById('authorize_button'),
            signOutBtn: document.getElementById('signout_button'),
            userName: document.getElementById('user-name'),
            themeToggle: document.getElementById('theme-toggle'),
            addDocBtn: document.getElementById('add-document-btn'),
            schoolYearSelect: document.getElementById('school-year-select'),
            yearList: document.getElementById('year-list'),
            newYearInput: document.getElementById('new-year-input'),
            addYearBtn: document.getElementById('add-year-btn'),
            manageYearsBtn: document.getElementById('manage-years-btn'),
            docModal: document.getElementById('document-modal'),
            yearModal: document.getElementById('school-year-modal'),
            closeDocModalBtn: document.getElementById('close-modal-btn'),
            cancelDocModalBtn: document.getElementById('cancel-modal-btn'),
            closeYearModalBtn: document.getElementById('close-year-modal-btn'),
            docForm: document.getElementById('document-form'),
            saveBtn: document.getElementById('save-btn'),
            docTableBody: document.getElementById('document-table-body'),
            searchInput: document.getElementById('search-input'),
            fileInput: document.getElementById('file_input'),
            modalTitle: document.getElementById('modal-title'),
            docFirestoreId: document.getElementById('doc-firestore-id'),
            fileViewerModal: document.getElementById('file-viewer-modal'),
            closeViewerBtn: document.getElementById('close-viewer-btn'),
            fileViewerTitle: document.getElementById('file-viewer-title'),
            fileList: document.getElementById('file-list'),
            viewerPlaceholder: document.getElementById('viewer-placeholder'),
            fileViewerIframe: document.getElementById('file-viewer-iframe'),
            docTypeFilter: document.getElementById('doc-type-filter'),
            docMonthFilter: document.getElementById('doc-month-filter'),
            uploadProgressContainer: document.getElementById('upload-progress-container'),
            uploadProgressBar: document.getElementById('upload-progress-bar'),
            uploadProgressText: document.getElementById('upload-progress-text'),
        };
        
        // --- AUTHENTICATION LOGIC ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // User is signed in.
                ui.authBtn.classList.add('hidden');
                ui.signOutBtn.classList.remove('hidden');
                ui.userName.textContent = `Xin chào, ${user.displayName || user.email}`;
                renderYears(); 
            } else {
                // User is signed out.
                ui.authBtn.classList.remove('hidden');
                ui.signOutBtn.classList.add('hidden');
                ui.userName.textContent = '';
                ui.docTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Vui lòng đăng nhập để xem dữ liệu...</td></tr>`;
                ui.schoolYearSelect.innerHTML = '<option>Vui lòng đăng nhập</option>';
            }
        });

        function handleGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
             // *** IOS PWA FIX STARTS HERE ***
            const isIosPwa = window.navigator.standalone;
            if (isIosPwa) {
                auth.signInWithPopup(provider).catch(error => {
                     console.error("Lỗi đăng nhập Google (Popup):", error);
                     alert(`Đăng nhập thất bại: ${error.message}`);
                });
            } else {
                auth.signInWithRedirect(provider);
            }
            // *** IOS PWA FIX ENDS HERE ***
        }

        function handleSignOut() {
            auth.signOut();
        }

        // --- FIRESTORE DATA LOGIC ---
        function getCollectionRef(collectionName) {
            if (!currentUser) return null;
            return db.collection('users').doc(currentUser.uid).collection(collectionName);
        }

        async function renderYears() {
            const yearsRef = getCollectionRef('schoolYears');
            if (!yearsRef) return;
            
            yearsRef.orderBy('name', 'desc').onSnapshot(snapshot => {
                const years = snapshot.docs.map(doc => doc.data().name);

                if (years.length === 0 && !snapshot.metadata.hasPendingWrites) {
                    const defaultYears = ["Năm học 2025-2026", "Năm học 2024-2025"];
                    const batch = db.batch();
                    defaultYears.forEach(year => {
                        const docRef = yearsRef.doc();
                        batch.set(docRef, { name: year });
                    });
                    batch.commit();
                    return;
                }

                const currentYear = ui.schoolYearSelect.value;
                ui.schoolYearSelect.innerHTML = '';
                ui.yearList.innerHTML = '';
                years.forEach(year => {
                    ui.schoolYearSelect.add(new Option(year, year));
                    ui.yearList.innerHTML += `<li class="flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md"><span class="text-sm">${year}</span><button data-year="${year}" class="delete-year-btn p-1 text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></li>`;
                });
                
                if (currentYear && years.includes(currentYear)) {
                    ui.schoolYearSelect.value = currentYear;
                }

                lucide.createIcons();
                renderDocuments();
            });
        }
        
        function populateDocTypeFilter() {
            const docTypes = ['Tất cả loại', 'Kế hoạch', 'Báo cáo', 'Quyết định', 'Thông báo', 'Công văn', 'Thông tư', 'Hướng dẫn', 'Quy định', 'Nghị quyết', 'Nghị định'];
            ui.docTypeFilter.innerHTML = '';
            docTypes.forEach(type => {
                const option = new Option(type, type === 'Tất cả loại' ? 'all' : type);
                ui.docTypeFilter.add(option);
            });
        }

        function populateMonthFilter() {
            const months = ['Tất cả tháng', 'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
            ui.docMonthFilter.innerHTML = '';
            months.forEach((month, index) => {
                const value = (index === 0) ? 'all' : String(index).padStart(2, '0');
                const option = new Option(month, value);
                ui.docMonthFilter.add(option);
            });
        }
        
        function renderDocuments() {
            if (unsubscribeDocuments) unsubscribeDocuments();

            const docsRef = getCollectionRef('documents');
            if (!docsRef) return;

            const selectedYear = ui.schoolYearSelect.value;
            const selectedType = ui.docTypeFilter.value;
            const selectedMonth = ui.docMonthFilter.value;
            const searchTerm = ui.searchInput.value.toLowerCase();
            
            if (!selectedYear) {
                 ui.docTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Vui lòng tạo năm học trước...</td></tr>`;
                return;
            }

            let query = docsRef.where('schoolYear', '==', selectedYear);
            if (selectedType !== 'all') query = query.where('type', '==', selectedType);
            if (selectedMonth !== 'all') query = query.where('month', '==', selectedMonth);
            query = query.orderBy('createdAt', 'desc');
            
            unsubscribeDocuments = query.onSnapshot(snapshot => {
                let docs = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));

                if (searchTerm) {
                    docs = docs.filter(doc => 
                        (doc.name && doc.name.toLowerCase().includes(searchTerm)) || 
                        (doc.id && doc.id.toLowerCase().includes(searchTerm))
                    );
                }

                ui.docTableBody.innerHTML = '';
                if (docs.length === 0) {
                    ui.docTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">Không có dữ liệu phù hợp...</td></tr>`;
                    return;
                }
                docs.forEach((doc, index) => {
                    const fileCount = doc.files?.length || 0;
                    const isLocked = doc.isLocked === true;
                    const rowClass = isLocked ? 'opacity-60' : '';
                    const lockIcon = isLocked ? '<i data-lucide="lock" class="w-4 h-4"></i>' : '<i data-lucide="unlock" class="w-4 h-4"></i>';
                    const lockTitle = isLocked ? 'Mở khóa' : 'Khóa';
                    const lockColor = isLocked ? 'text-yellow-500' : 'text-gray-400';

                    ui.docTableBody.innerHTML += `
                        <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 ${rowClass}" data-doc-id="${doc.firestoreId}">
                            <td class="py-4 px-6 view-files-cell">${index + 1}</td>
                            <th class="py-4 px-6 font-medium text-gray-900 dark:text-white view-files-cell">${doc.name || ''}</th>
                            <td class="py-4 px-6 view-files-cell">${doc.id || ''}</td>
                            <td class="py-4 px-6 view-files-cell">${formatDate(doc.date)}</td>
                            <td class="py-4 px-6 text-sm view-files-cell">
                                <span class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">
                                    <i data-lucide="paperclip" class="w-3 h-3 mr-1"></i>
                                    ${fileCount} tệp
                                </span>
                            </td>
                            <td class="py-4 px-6 view-files-cell">${doc.status || ''}</td>
                            <td class="py-4 px-6 flex items-center space-x-2">
                                <button data-doc-id="${doc.firestoreId}" data-locked="${isLocked}" class="toggle-lock-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 ${lockColor}" title="${lockTitle}">${lockIcon}</button>
                                <button data-doc-id="${doc.firestoreId}" class="edit-doc-btn p-2 text-green-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Chỉnh sửa" ${isLocked ? 'disabled' : ''}><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-doc-id="${doc.firestoreId}" class="delete-doc-btn p-2 text-red-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Xóa" ${isLocked ? 'disabled' : ''}><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>`;
                });
                lucide.createIcons();
            }, error => {
                console.error("Firestore Error: ", error);
                ui.docTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-red-500">Đã xảy ra lỗi. Vui lòng kiểm tra Console (F12) để tạo Index cần thiết.</td></tr>`;
            });
        }
        
        async function openFileViewer(docId) {
            const docRef = getCollectionRef('documents').doc(docId);
            const docSnap = await docRef.get();
            if (!docSnap.exists) {
                alert('Không tìm thấy văn bản!'); return;
            }

            const docData = docSnap.data();
            const files = docData.files || [];

            ui.fileViewerTitle.textContent = `Tệp đính kèm cho: ${docData.name}`;
            ui.fileList.innerHTML = '';
            ui.viewerPlaceholder.classList.remove('hidden');
            ui.fileViewerIframe.classList.add('hidden');
            ui.fileViewerIframe.src = 'about:blank';

            if (files.length === 0) {
                ui.fileList.innerHTML = '<li class="text-sm text-gray-500">Không có tệp nào.</li>';
            } else {
                files.forEach((file) => {
                    const li = document.createElement('li');
                    li.className = 'file-item p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center text-sm';
                    li.innerHTML = `
                        <i data-lucide="file-text" class="w-4 h-4 mr-2 shrink-0"></i>
                        <span class="flex-grow truncate" title="${file.name}">${file.name}</span>
                        <a href="${file.url}" target="_blank" download="${file.name}" class="download-btn p-1 text-gray-400 hover:text-blue-500 ml-2 shrink-0" title="Tải về">
                           <i data-lucide="download" class="w-4 h-4"></i>
                        </a>
                    `;
                    if (file.type.startsWith('image/')) {
                       li.addEventListener('click', (e) => {
                            if (e.target.closest('.download-btn')) return;
                            document.querySelectorAll('.file-item').forEach(item => item.classList.remove('selected'));
                            li.classList.add('selected');
                            ui.viewerPlaceholder.classList.add('hidden');
                            ui.fileViewerIframe.src = file.url;
                            ui.fileViewerIframe.classList.remove('hidden');
                        });
                    }
                    ui.fileList.appendChild(li);
                });
                lucide.createIcons();
            }
            ui.fileViewerModal.classList.remove('hidden');
        }

        // --- HELPER FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        async function toggleLockStatus(docId, currentStatus) {
            const docRef = getCollectionRef('documents').doc(docId);
            try {
                await docRef.update({ isLocked: !currentStatus });
            } catch (error) {
                console.error("Error updating lock status:", error);
                alert("Đã xảy ra lỗi khi cập nhật trạng thái khóa.");
            }
        }

        // --- EVENT LISTENERS ---
        ui.authBtn.addEventListener('click', handleGoogleSignIn);
        ui.signOutBtn.addEventListener('click', handleSignOut);
        ui.themeToggle.addEventListener('click', () => document.documentElement.classList.toggle('dark'));
        
        ui.addDocBtn.addEventListener('click', () => {
            ui.docForm.reset();
            ui.docFirestoreId.value = '';
            ui.modalTitle.textContent = 'Thêm Văn bản Mới';
            ui.fileInput.required = true;
            ui.docModal.classList.remove('hidden');
        });
        
        [ui.closeDocModalBtn, ui.cancelDocModalBtn].forEach(btn => btn.addEventListener('click', () => ui.docModal.classList.add('hidden')));
        ui.closeYearModalBtn.addEventListener('click', () => ui.yearModal.classList.add('hidden'));
        ui.closeViewerBtn.addEventListener('click', () => {
            ui.fileViewerModal.classList.add('hidden');
            ui.fileViewerIframe.src = 'about:blank';
        });
        
        ui.manageYearsBtn.addEventListener('click', () => ui.yearModal.classList.remove('hidden'));

        ui.addYearBtn.addEventListener('click', async () => {
            const newYear = ui.newYearInput.value.trim();
            if (newYear) {
                const yearsRef = getCollectionRef('schoolYears');
                if (!yearsRef) return alert('Vui lòng đăng nhập');
                const existing = await yearsRef.where('name', '==', newYear).get();
                if (existing.empty) {
                    await yearsRef.add({ name: newYear });
                } else {
                    alert('Năm học này đã tồn tại!');
                }
                ui.newYearInput.value = '';
            }
        });

        ui.yearList.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-year-btn');
            if (deleteBtn) {
                const yearToDelete = deleteBtn.dataset.year;
                if (confirm(`Bạn có chắc muốn xóa "${yearToDelete}"? Việc này sẽ xóa TẤT CẢ văn bản trong năm học này.`)) {
                    const yearsRef = getCollectionRef('schoolYears');
                    const docsRef = getCollectionRef('documents');
                    if (!yearsRef || !docsRef) return;
                    
                    const yearQuery = await yearsRef.where('name', '==', yearToDelete).get();
                    const docQuery = await docsRef.where('schoolYear', '==', yearToDelete).get();

                    const batch = db.batch();
                    yearQuery.forEach(doc => batch.delete(doc.ref));
                    for(const doc of docQuery.docs) {
                        const docData = doc.data();
                        if(docData.files && docData.files.length > 0) {
                            for(const file of docData.files) {
                                storage.refFromURL(file.url).delete().catch(e => console.error("Error deleting file from storage", e));
                            }
                        }
                        batch.delete(doc.ref);
                    }
                    await batch.commit();
                }
            }
        });
        
        ui.docTableBody.addEventListener('click', async (e) => {
            const viewCell = e.target.closest('.view-files-cell');
            const deleteBtn = e.target.closest('.delete-doc-btn');
            const editBtn = e.target.closest('.edit-doc-btn');
            const lockBtn = e.target.closest('.toggle-lock-btn');
            
            if (lockBtn) {
                e.stopPropagation();
                toggleLockStatus(lockBtn.dataset.docId, lockBtn.dataset.locked === 'true');
                return;
            }

            if (deleteBtn) {
                e.stopPropagation();
                const docId = deleteBtn.dataset.docId;
                if (confirm('Bạn có chắc muốn xóa văn bản này?')) {
                    const docRef = getCollectionRef('documents').doc(docId);
                    const docSnap = await docRef.get();
                    if(docSnap.exists) {
                        const docData = docSnap.data();
                        if(docData.files && docData.files.length > 0) {
                            for(const file of docData.files) {
                                storage.refFromURL(file.url).delete().catch(e => console.error("Error deleting file from storage", e));
                            }
                        }
                        await docRef.delete();
                    }
                }
                return;
            }
            
            if (editBtn) {
                e.stopPropagation();
                const docId = editBtn.dataset.docId;
                const docRef = getCollectionRef('documents').doc(docId);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    document.getElementById('doc-name').value = data.name || '';
                    document.getElementById('doc-id').value = data.id || '';
                    document.getElementById('doc-date').value = data.date || '';
                    document.getElementById('doc-type').value = data.type || '';
                    document.getElementById('doc-status').value = data.status || '';
                    ui.docFirestoreId.value = docId;
                    ui.modalTitle.textContent = 'Chỉnh sửa Văn bản';
                    ui.fileInput.required = false;
                    ui.docModal.classList.remove('hidden');
                }
                return;
            }

            if (viewCell) {
                openFileViewer(viewCell.closest('tr').dataset.docId);
            }
        });
        
        [ui.schoolYearSelect, ui.searchInput, ui.docTypeFilter, ui.docMonthFilter].forEach(el => {
            const eventType = el.tagName === 'INPUT' ? 'input' : 'change';
            el.addEventListener(eventType, renderDocuments);
        });
        
        ui.saveBtn.addEventListener('click', async () => {
            if (!ui.docForm.checkValidity()) {
                ui.docForm.reportValidity(); return;
            }
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước khi thực hiện.'); return;
            }

            ui.saveBtn.disabled = true;
            ui.saveBtn.textContent = 'Đang xử lý...';
            
            try {
                const docData = {
                    schoolYear: ui.schoolYearSelect.value,
                    name: document.getElementById('doc-name').value.trim(),
                    id: document.getElementById('doc-id').value.trim(),
                    date: document.getElementById('doc-date').value,
                    type: document.getElementById('doc-type').value,
                    status: document.getElementById('doc-status').value,
                    month: document.getElementById('doc-date').value ? document.getElementById('doc-date').value.substring(5, 7) : ''
                };
                
                const existingDocId = ui.docFirestoreId.value;
                const filesToUpload = ui.fileInput.files;

                if (filesToUpload.length > 0) {
                     docData.files = await uploadFiles(filesToUpload);
                }

                const docsRef = getCollectionRef('documents');

                if (existingDocId) {
                    await docsRef.doc(existingDocId).update(docData);
                } else {
                    docData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    docData.isLocked = false;
                    await docsRef.add(docData);
                }
                
                alert('Lưu thông tin thành công!');
                ui.docModal.classList.add('hidden');
                ui.docForm.reset();
            } catch (error) {
                console.error("Save process failed:", error);
                alert(`Đã xảy ra lỗi: ${error.message}`);
            } finally {
                ui.saveBtn.disabled = false;
                ui.saveBtn.textContent = 'Lưu lại';
                ui.uploadProgressContainer.classList.add('hidden');
            }
        });
        
        // --- FIREBASE STORAGE UPLOAD LOGIC ---
        async function uploadFiles(files) {
            const fileData = [];
            let totalUploaded = 0;
            const totalFiles = files.length;
            
            ui.uploadProgressContainer.classList.remove('hidden');
            
            for (const file of files) {
                const filePath = `users/${currentUser.uid}/documents/${Date.now()}_${file.name}`;
                const fileRef = storage.ref(filePath);
                
                const uploadTask = fileRef.put(file);

                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                             const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                             const overallProgress = ((totalUploaded + (progress / 100)) / totalFiles) * 100;
                             ui.uploadProgressBar.style.width = overallProgress + '%';
                             ui.uploadProgressText.textContent = `Đang tải tệp ${totalUploaded + 1}/${totalFiles}... ${Math.round(progress)}%`;
                        }, 
                        (error) => {
                            console.error("Upload failed:", error);
                            reject(error);
                        }, 
                        async () => {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            fileData.push({
                                name: file.name,
                                url: downloadURL,
                                path: filePath,
                                type: file.type
                            });
                            totalUploaded++;
                            resolve();
                        }
                    );
                });
            }
            return fileData;
        }

        // --- INITIAL LOAD ---
        populateDocTypeFilter();
        populateMonthFilter();
    });

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                console.log('ServiceWorker registration successful.', reg);
            }).catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    </script>
</body>
</html>

