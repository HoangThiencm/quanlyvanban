<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Văn bản Nội bộ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        body { transition: background-color 0.3s, color 0.3s; }
        #auth-status {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 dark:text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Hệ thống Quản lý Văn bản</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div id="auth-status" class="flex items-center space-x-2">
                             <button id="authorize_button" class="hidden flex items-center bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-600">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                                 Đăng nhập Google
                             </button>
                             <button id="signout_button" class="hidden bg-gray-200 text-gray-800 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-300">Đăng xuất</button>
                             <p id="user-name" class="text-sm font-medium"></p>
                         </div>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                            <i data-lucide="sun" class="h-5 w-5 block dark:hidden"></i>
                            <i data-lucide="moon" class="h-5 w-5 hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <!-- Controls: Filter, Search, Add -->
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 mb-6">
                    <div class="w-full md:w-auto flex items-center space-x-2">
                        <div class="flex-grow">
                            <label for="school-year-select" class="sr-only">Năm học</label>
                            <select id="school-year-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <button id="manage-years-btn" title="Quản lý năm học" class="p-2.5 text-gray-500 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-600 flex-shrink-0">
                            <i data-lucide="settings-2" class="w-5 h-5"></i>
                        </button>
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input type="search" id="search-input" class="w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Tìm theo tên, số ký hiệu, nội dung...">
                        </div>
                    </div>
                    <button id="add-document-btn" class="w-full md:w-auto flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Thêm Văn bản Mới
                    </button>
                </div>

                <!-- Documents Table -->
                <div class="overflow-x-auto relative">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="py-3 px-6 rounded-l-lg">STT</th>
                                <th scope="col" class="py-3 px-6">Tên Văn bản / Trích yếu</th>
                                <th scope="col" class="py-3 px-6">Số/Ký hiệu</th>
                                <th scope="col" class="py-3 px-6">Ngày Ban hành</th>
                                <th scope="col" class="py-3 px-6">Loại VB</th>
                                <th scope="col" class="py-3 px-6">Trạng thái</th>
                                <th scope="col" class="py-3 px-6 rounded-r-lg">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="document-table-body">
                            <!-- Data will be populated here -->
                            <tr id="no-data-row">
                                <td colspan="7" class="text-center py-10 text-gray-500">Chưa có dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add/Edit Document Modal -->
    <div id="document-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Thêm Văn bản Mới</h3>
                <button id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i><span class="sr-only">Đóng</span>
                </button>
            </div>
            <div class="p-6 space-y-6">
                 <!-- Form content remains the same -->
                 <form action="#">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="doc-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tên văn bản / Trích yếu</label>
                            <input type="text" name="doc-name" id="doc-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: Kế hoạch tổ chức..." required >
                        </div>
                        <div>
                            <label for="doc-id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Số/Ký hiệu</label>
                            <input type="text" name="doc-id" id="doc-id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: 123/KH-ĐHABC">
                        </div>
                        <div>
                            <label for="doc-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Ngày ban hành</label>
                            <input type="date" name="doc-date" id="doc-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        </div>
                         <div>
                            <label for="doc-type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Loại văn bản</label>
                            <select id="doc-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option>Kế hoạch</option><option>Báo cáo</option><option>Quyết định</option><option>Thông báo</option><option>Công văn</option>
                            </select>
                        </div>
                         <div>
                            <label for="doc-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Trạng thái</label>
                            <select id="doc-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option>Chờ xử lý</option><option>Đã xử lý</option><option>Lưu trữ</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                             <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="file_input">Tải file lên (có thể chọn nhiều file)</label>
                             <input class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" id="file_input" type="file" multiple>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button id="save-btn" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Lưu lại</button>
                <button id="cancel-modal-btn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">Hủy bỏ</button>
            </div>
        </div>
    </div>

    <!-- Manage School Years Modal -->
    <div id="school-year-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Quản lý Năm học</h3>
                <button id="close-year-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i><span class="sr-only">Đóng</span>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="new-year-input" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Thêm năm học mới</label>
                    <div class="flex space-x-2">
                        <input type="text" id="new-year-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" placeholder="VD: Năm học 2026-2027">
                        <button id="add-year-btn" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">Thêm</button>
                    </div>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    <ul id="year-list" class="space-y-2">
                        <!-- Year list populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); });

        // School Year Management
        const schoolYearSelect = document.getElementById('school-year-select');
        const yearList = document.getElementById('year-list');
        const newYearInput = document.getElementById('new-year-input');
        const addYearBtn = document.getElementById('add-year-btn');
        const SCHOOL_YEARS_KEY = 'schoolYearsList';

        function getSchoolYears() {
            const years = localStorage.getItem(SCHOOL_YEARS_KEY);
            if (years) {
                return JSON.parse(years);
            } else {
                // Default values if nothing is stored
                const defaultYears = ["Năm học 2025-2026", "Năm học 2024-2025", "Năm học 2023-2024"];
                localStorage.setItem(SCHOOL_YEARS_KEY, JSON.stringify(defaultYears));
                return defaultYears;
            }
        }

        function saveSchoolYears(years) {
            localStorage.setItem(SCHOOL_YEARS_KEY, JSON.stringify(years));
            loadSchoolYears();
        }

        function loadSchoolYears() {
            const years = getSchoolYears();
            schoolYearSelect.innerHTML = '';
            yearList.innerHTML = '';
            years.forEach(year => {
                // Populate dropdown
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                schoolYearSelect.appendChild(option);

                // Populate management list
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                li.innerHTML = `
                    <span class="text-sm">${year}</span>
                    <button data-year="${year}" class="delete-year-btn p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                yearList.appendChild(li);
            });
            lucide.createIcons(); // Re-render icons
        }

        addYearBtn.addEventListener('click', () => {
            const newYear = newYearInput.value.trim();
            if (newYear) {
                const years = getSchoolYears();
                if (!years.includes(newYear)) {
                    years.unshift(newYear); // Add to the beginning
                    saveSchoolYears(years);
                    newYearInput.value = '';
                } else {
                    alert('Năm học này đã tồn tại!');
                }
            }
        });

        yearList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-year-btn');
            if (deleteBtn) {
                const yearToDelete = deleteBtn.dataset.year;
                if (confirm(`Bạn có chắc chắn muốn xóa "${yearToDelete}" không?`)) {
                    let years = getSchoolYears();
                    years = years.filter(y => y !== yearToDelete);
                    saveSchoolYears(years);
                }
            }
        });

        // Modal Controls
        const docModal = document.getElementById('document-modal');
        const yearModal = document.getElementById('school-year-modal');
        const openDocModal = () => docModal.classList.remove('hidden');
        const closeDocModal = () => {
            docModal.classList.add('hidden');
            // Reset form on close
            document.getElementById('doc-name').value = '';
            document.getElementById('doc-id').value = '';
            document.getElementById('doc-date').value = '';
            document.getElementById('file_input').value = '';
        }
        const openYearModal = () => yearModal.classList.remove('hidden');
        const closeYearModal = () => yearModal.classList.add('hidden');
        
        document.getElementById('add-document-btn').addEventListener('click', openDocModal);
        document.getElementById('close-modal-btn').addEventListener('click', closeDocModal);
        document.getElementById('cancel-modal-btn').addEventListener('click', closeDocModal);
        docModal.addEventListener('click', e => { if (e.target === docModal) closeDocModal(); });

        document.getElementById('manage-years-btn').addEventListener('click', openYearModal);
        document.getElementById('close-year-modal-btn').addEventListener('click', closeYearModal);
        yearModal.addEventListener('click', e => { if (e.target === yearModal) closeYearModal(); });

        document.getElementById('save-btn').addEventListener('click', async () => {
            const files = document.getElementById('file_input').files;
            const docName = document.getElementById('doc-name').value.trim();

            if (files.length === 0) {
                alert('Vui lòng chọn ít nhất một file để tải lên.');
                return;
            }
            if (!docName) {
                alert('Vui lòng nhập "Tên văn bản / Trích yếu". Tên này sẽ được dùng để tạo thư mục chứa file.');
                return;
            }
            
            alert(`Bắt đầu quá trình tải lên ${files.length} file. Vui lòng chờ...`);
            let successCount = 0;
            let errorCount = 0;
            
            for (const file of files) {
                try {
                    await handleSingleFileUpload(file, docName);
                    successCount++;
                } catch (error) {
                    console.error(`Lỗi khi tải file ${file.name}:`, error);
                    errorCount++;
                }
            }

            alert(`Hoàn tất! Tải lên thành công ${successCount} file. Thất bại: ${errorCount} file.`);
            
            if (successCount > 0) {
                closeDocModal();
            }
        });

        // Initial load
        loadSchoolYears();
    });

    function slugify(text) {
      const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
      const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
      const p = new RegExp(a.split('').join('|'), 'g')

      return text.toString().toLowerCase()
        .replace(/\s+/g, '-') // Replace spaces with -
        .replace(p, c => b.charAt(a.indexOf(c))) // Replace special characters
        .replace(/&/g, '-and-') // Replace & with 'and'
        .replace(/[^\w\-]+/g, '') // Remove all non-word chars
        .replace(/\-\-+/g, '-') // Replace multiple - with single -
        .replace(/^-+/, '') // Trim - from start of text
        .replace(/-+$/, '') // Trim - from end of text
    }
    </script>
    
    <!-- Google API Integration -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        const API_KEY = 'AIzaSyAn17SI2Xwx1ek-2xPw3IilNxPKG6O7nGg';
        const CLIENT_ID = '1882095959563-o84nk4siirudogbilev689nedlbciuhl.apps.googleusercontent.com';
        
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Will be set later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.visibility = 'visible';
                document.getElementById('authorize_button').onclick = handleAuthClick;
                document.getElementById('signout_button').onclick = handleSignoutClick;
            }
        }
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                updateUIWithToken(gapi.client.getToken());
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateUIWithToken(null);
            }
        }
        
        function updateUIWithToken(token) {
            const authButton = document.getElementById('authorize_button');
            const signoutButton = document.getElementById('signout_button');
            const userNameEl = document.getElementById('user-name');
            if (token) {
                authButton.style.display = 'none';
                signoutButton.style.display = 'block';
                gapi.client.oauth2.userinfo.get().then(response => {
                    userNameEl.textContent = `Xin chào, ${response.result.name}`;
                });
            } else {
                authButton.style.display = 'block';
                signoutButton.style.display = 'none';
                userNameEl.textContent = '';
            }
        }

        async function handleSingleFileUpload(file, docName) {
            if (!gapi.client.getToken()) {
                alert("Bạn cần đăng nhập Google trước khi tải file!");
                handleAuthClick();
                throw new Error("Chưa đăng nhập Google");
            }

            const schoolYear = document.getElementById('school-year-select').value;
            if (!schoolYear) {
                alert("Vui lòng chọn hoặc thêm một năm học.");
                throw new Error("Chưa chọn năm học");
            }
            const currentMonth = `Tháng ${String(new Date().getMonth() + 1).padStart(2, '0')}`;
            const documentFolderName = slugify(docName);
            
            const qlvbFolderId = await findOrCreateFolder('QLVB');
            const yearFolderId = await findOrCreateFolder(schoolYear, qlvbFolderId);
            const monthFolderId = await findOrCreateFolder(currentMonth, yearFolderId);
            const docFolderId = await findOrCreateFolder(documentFolderName, monthFolderId);

            await uploadFileToFolder(file, docFolderId);
        }

        async function findOrCreateFolder(folderName, parentId = 'root') {
            const response = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and '${parentId}' in parents and trashed=false`,
                fields: 'files(id, name)',
            });

            if (response.result.files.length > 0) {
                console.log(`Đã tìm thấy thư mục '${folderName}' với ID: ${response.result.files[0].id}`);
                return response.result.files[0].id;
            } else {
                console.log(`Không tìm thấy thư mục '${folderName}'. Đang tạo mới...`);
                const fileMetadata = {
                    'name': folderName,
                    'mimeType': 'application/vnd.google-apps.folder',
                    'parents': [parentId]
                };
                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                console.log(`Đã tạo thư mục '${folderName}' với ID: ${createResponse.result.id}`);
                return createResponse.result.id;
            }
        }

        function uploadFileToFolder(file, folderId) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = () => {
                    const fileContent = reader.result;
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";

                    const metadata = {
                        'name': file.name, 'mimeType': file.type || 'application/octet-stream', 'parents': [folderId]
                    };

                    const base64Data = btoa(new Uint8Array(fileContent).reduce((data, byte) => data + String.fromCharCode(byte), ''));

                    const multipartRequestBody =
                        delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata) +
                        delimiter + 'Content-Type: ' + (file.type || 'application/octet-stream') + '\r\n' + 'Content-Transfer-Encoding: base64\r\n\r\n' + base64Data + close_delim;
                    
                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files', 'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
                        'body': multipartRequestBody
                    });

                    request.execute(function(file, rawResponse) {
                        if (file.id) {
                            console.log('File đã tải lên:', file);
                            // alert(`Tải file '${file.name}' thành công!`); // Removed for multi-upload
                            resolve(file);
                        } else {
                           reject(JSON.parse(rawResponse.body));
                        }
                    });
                };
                 reader.onerror = error => reject(error);
             });
        }
    </script>
</body>
</html>

