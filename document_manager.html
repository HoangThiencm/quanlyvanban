<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Văn bản Nội bộ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        body { transition: background-color 0.3s, color 0.3s; }
        #auth-status {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 dark:text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Hệ thống Quản lý Văn bản</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div id="auth-status" class="flex items-center space-x-2">
                             <button id="authorize_button" class="hidden flex items-center bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-600">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                                 Đăng nhập Google
                             </button>
                             <button id="signout_button" class="hidden bg-gray-200 text-gray-800 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-300">Đăng xuất</button>
                             <p id="user-name" class="text-sm font-medium"></p>
                         </div>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                            <i data-lucide="sun" class="h-5 w-5 block dark:hidden"></i>
                            <i data-lucide="moon" class="h-5 w-5 hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
             <!-- ... (Phần bảng và các thành phần khác không thay đổi) ... -->
                            <i data-lucide="moon" class="h-5 w-5 hidden dark:block"></i>
                        </button>
                        <div class="relative">
                            <button class="flex items-center space-x-2">
                                <img class="h-8 w-8 rounded-full" src="https://placehold.co/40x40/E2E8F0/4A5568?text=AV" alt="Avatar">
                                <span class="hidden md:block font-medium text-sm">Văn Thư</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <!-- Controls: Filter, Search, Add -->
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 mb-6">
                    <div class="w-full md:w-auto flex items-center space-x-4">
                        <div>
                            <label for="school-year" class="sr-only">Năm học</label>
                            <select id="school-year" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option selected>Năm học 2024-2025</option>
                                <option>Năm học 2023-2024</option>
                                <option>Năm học 2022-2023</option>
                                <option>Tất cả các năm</option>
                            </select>
                        </div>
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input type="search" id="search-input" class="w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Tìm theo tên, số ký hiệu, nội dung...">
                        </div>
                    </div>
                    <button id="add-document-btn" class="w-full md:w-auto flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Thêm Văn bản Mới
                    </button>
                </div>

                <!-- Documents Table -->
                <div class="overflow-x-auto relative">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="py-3 px-6 rounded-l-lg">STT</th>
                                <th scope="col" class="py-3 px-6">Tên Văn bản / Trích yếu</th>
                                <th scope="col" class="py-3 px-6">Số/Ký hiệu</th>
                                <th scope="col" class="py-3 px-6">Ngày Ban hành</th>
                                <th scope="col" class="py-3 px-6">Loại VB</th>
                                <th scope="col" class="py-3 px-6">Trạng thái</th>
                                <th scope="col" class="py-3 px-6 rounded-r-lg">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Mẫu dữ liệu 1 -->
                            <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <td class="py-4 px-6">1</td>
                                <th scope="row" class="py-4 px-6 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i data-lucide="file-text" class="w-4 h-4 mr-2 text-blue-500"></i>
                                        <span>Kế hoạch tổ chức Hội nghị Cán bộ, Viên chức năm học 2024-2025</span>
                                    </div>
                                </th>
                                <td class="py-4 px-6">123/KH-ĐHABC</td>
                                <td class="py-4 px-6">20/08/2024</td>
                                <td class="py-4 px-6">Kế hoạch</td>
                                <td class="py-4 px-6">
                                    <span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">Đã xử lý</span>
                                </td>
                                <td class="py-4 px-6 flex items-center space-x-2">
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Xem trên Google Drive"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Tải xuống"><i data-lucide="download" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Chia sẻ"><i data-lucide="share-2" class="w-4 h-4"></i></a>
                                </td>
                            </tr>
                            <!-- Mẫu dữ liệu 2 -->
                            <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <td class="py-4 px-6">2</td>
                                <th scope="row" class="py-4 px-6 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2 text-green-500"></i>
                                        <span>Báo cáo tổng kết công tác tuyển sinh năm 2024</span>
                                    </div>
                                </th>
                                <td class="py-4 px-6">45/BC-TS</td>
                                <td class="py-4 px-6">15/08/2024</td>
                                <td class="py-4 px-6">Báo cáo</td>
                                <td class="py-4 px-6">
                                     <span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Chờ xử lý</span>
                                </td>
                                <td class="py-4 px-6 flex items-center space-x-2">
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Xem trên Google Drive"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Tải xuống"><i data-lucide="download" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Chia sẻ"><i data-lucide="share-2" class="w-4 h-4"></i></a>
                                </td>
                            </tr>
                             <!-- Mẫu dữ liệu 3 -->
                            <tr class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <td class="py-4 px-6">3</td>
                                <th scope="row" class="py-4 px-6 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i data-lucide="file-bar-chart-2" class="w-4 h-4 mr-2 text-red-500"></i>
                                        <span>Quyết định về việc thành lập Hội đồng Khoa học và Đào tạo</span>
                                    </div>
                                </th>
                                <td class="py-4 px-6">789/QĐ-HĐKH</td>
                                <td class="py-4 px-6">10/08/2024</td>
                                <td class="py-4 px-6">Quyết định</td>
                                <td class="py-4 px-6">
                                    <span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full dark:bg-gray-900 dark:text-gray-300">Lưu trữ</span>
                                </td>
                                <td class="py-4 px-6 flex items-center space-x-2">
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Xem trên Google Drive"><i data-lucide="eye" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Tải xuống"><i data-lucide="download" class="w-4 h-4"></i></a>
                                    <a href="#" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Chia sẻ"><i data-lucide="share-2" class="w-4 h-4"></i></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                 <nav class="flex items-center justify-between pt-4" aria-label="Table navigation">
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Hiển thị <span class="font-semibold text-gray-900 dark:text-white">1-10</span> của <span class="font-semibold text-gray-900 dark:text-white">1000</span></span>
                    <ul class="inline-flex items-center -space-x-px">
                        <li>
                            <a href="#" class="block py-2 px-3 ml-0 leading-tight text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                                <span class="sr-only">Previous</span>
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </a>
                        </li>
                        <!-- Các trang khác ở đây -->
                        <li>
                            <a href="#" aria-current="page" class="z-10 py-2 px-3 leading-tight text-blue-600 bg-blue-50 border border-blue-300 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white">1</a>
                        </li>
                        <li>
                            <a href="#" class="py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">2</a>
                        </li>
                        <li>
                            <a href="#" class="block py-2 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                                <span class="sr-only">Next</span>
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </main>
    </div>
    
    <!-- Add/Edit Document Modal -->
    <div id="document-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <!-- ... (Nội dung modal không thay đổi) ... -->
            <div class="flex justify-between items-center p-5 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Thêm Văn bản Mới</h3>
                <button id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                    <span class="sr-only">Đóng</span>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <form action="#">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="doc-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tên văn bản / Trích yếu</label>
                            <input type="text" name="doc-name" id="doc-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: Kế hoạch tổ chức..." required>
                        </div>
                        <div>
                            <label for="doc-id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Số/Ký hiệu</label>
                            <input type="text" name="doc-id" id="doc-id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="VD: 123/KH-ĐHABC">
                        </div>
                        <div>
                            <label for="doc-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Ngày ban hành</label>
                            <input type="date" name="doc-date" id="doc-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        </div>
                         <div>
                            <label for="doc-type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Loại văn bản</label>
                            <select id="doc-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option>Kế hoạch</option>
                                <option>Báo cáo</option>
                                <option>Quyết định</option>
                                <option>Thông báo</option>
                                <option>Công văn</option>
                            </select>
                        </div>
                         <div>
                            <label for="doc-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Trạng thái</label>
                            <select id="doc-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option>Chờ xử lý</option>
                                <option>Đã xử lý</option>
                                <option>Lưu trữ</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                             <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="file_input">Tải file lên (sẽ lưu vào Google Drive)</label>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Sau khi chọn, hệ thống sẽ tự động tải lên và lấy đường dẫn.</p>
                             <input class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" id="file_input" type="file">
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button id="save-btn" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Lưu lại</button>
                <button id="cancel-modal-btn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">Hủy bỏ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); });
            const modal = document.getElementById('document-modal');
            const addBtn = document.getElementById('add-document-btn');
            const closeBtn = document.getElementById('close-modal-btn');
            const cancelBtn = document.getElementById('cancel-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const fileInput = document.getElementById('file_input');
            const openModal = () => modal.classList.remove('hidden');
            const closeModal = () => modal.classList.add('hidden');
            addBtn.addEventListener('click', openModal);
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => { if (event.target === modal) { closeModal(); }});
            
            // Lắng nghe sự kiện nhấn nút Lưu
            saveBtn.addEventListener('click', () => {
                const files = fileInput.files;
                if (files && files.length > 0) {
                    handleFileUpload(files[0]);
                } else {
                    alert('Vui lòng chọn một file để tải lên.');
                }
            });
        });
    </script>
    
    <!-- Google API Integration -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        // THAY THẾ CÁC GIÁ TRỊ NÀY BẰNG THÔNG TIN CỦA BẠN
        const API_KEY = 'DÁN_API_KEY_CỦA_BẠN_VÀO_ĐÂY';
        const CLIENT_ID = 'DÁN_CLIENT_ID_CỦA_BẠN_VÀO_ĐÂY';
        
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Sẽ được đặt lại khi cần
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.visibility = 'visible';
                 document.getElementById('authorize_button').onclick = handleAuthClick;
                 document.getElementById('signout_button').onclick = handleSignoutClick;
            }
        }
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                updateUIWithToken(gapi.client.getToken());
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateUIWithToken(null);
            }
        }
        
        function updateUIWithToken(token) {
            const authButton = document.getElementById('authorize_button');
            const signoutButton = document.getElementById('signout_button');
            const userNameEl = document.getElementById('user-name');
            if (token) {
                authButton.style.display = 'none';
                signoutButton.style.display = 'block';
                // Lấy thông tin người dùng
                gapi.client.oauth2.userinfo.get().then(response => {
                    userNameEl.textContent = `Xin chào, ${response.result.name}`;
                });
            } else {
                authButton.style.display = 'block';
                signoutButton.style.display = 'none';
                userNameEl.textContent = '';
            }
        }

        async function handleFileUpload(file) {
            if (!gapi.client.getToken()) {
                alert("Bạn cần đăng nhập Google trước khi tải file!");
                handleAuthClick();
                return;
            }

            const schoolYear = document.getElementById('school-year').value;
            const currentMonth = `Tháng ${new Date().getMonth() + 1}`;
            
            try {
                alert('Bắt đầu quá trình tải lên. Vui lòng chờ...');
                // 1. Tìm hoặc tạo thư mục năm học
                const yearFolderId = await findOrCreateFolder(schoolYear);
                // 2. Tìm hoặc tạo thư mục tháng trong thư mục năm học
                const monthFolderId = await findOrCreateFolder(currentMonth, yearFolderId);
                // 3. Tải file vào thư mục tháng
                await uploadFileToFolder(file, monthFolderId);

            } catch (error) {
                console.error('Lỗi:', error);
                alert('Đã xảy ra lỗi khi tải file. Chi tiết: ' + error.message);
            }
        }

        async function findOrCreateFolder(folderName, parentId = 'root') {
            // Tìm kiếm thư mục
            const response = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and '${parentId}' in parents and trashed=false`,
                fields: 'files(id, name)',
            });

            if (response.result.files.length > 0) {
                console.log(`Đã tìm thấy thư mục '${folderName}' với ID: ${response.result.files[0].id}`);
                return response.result.files[0].id;
            } else {
                console.log(`Không tìm thấy thư mục '${folderName}'. Đang tạo mới...`);
                // Tạo thư mục nếu không tồn tại
                const fileMetadata = {
                    'name': folderName,
                    'mimeType': 'application/vnd.google-apps.folder',
                    'parents': [parentId]
                };
                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                console.log(`Đã tạo thư mục '${folderName}' với ID: ${createResponse.result.id}`);
                return createResponse.result.id;
            }
        }

        function uploadFileToFolder(file, folderId) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = () => {
                    const fileContent = reader.result;
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";

                    const metadata = {
                        'name': file.name,
                        'mimeType': file.type || 'application/octet-stream',
                        'parents': [folderId]
                    };

                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' + (file.type || 'application/octet-stream') + '\r\n' +
                        'Content-Transfer-Encoding: base64\r\n' +
                        '\r\n' +
                        btoa(String.fromCharCode.apply(null, new Uint8Array(fileContent))) +
                        close_delim;
                    
                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
                        'body': multipartRequestBody
                    });

                    request.execute(function(file) {
                        console.log('File đã tải lên:', file);
                        alert(`Tải file '${file.name}' thành công!`);
                        resolve(file);
                    });
                };
                 reader.onerror = error => reject(error);
             });
        }
        
    </script>
</body>
</html>

